From e830ce96e3d349aeb20e5096199ec12fd60837da Mon Sep 17 00:00:00 2001
From: Willie Randolph <RazzleberryT@gmail.com>
Date: Fri, 18 Jul 2025 23:41:18 -0400
Subject: [PATCH 13/27] fix: handle herb data load errors (#119)

---
 src/hooks/useHerbs.ts    | 15 +++++++++++----
 src/pages/Compare.tsx    | 11 +++++++++++
 src/pages/Compounds.tsx  | 11 +++++++++++
 src/pages/Database.tsx   | 16 +++++++++++++++-
 src/pages/Favorites.tsx  | 11 +++++++++++
 src/pages/HerbDetail.tsx |  7 +++++++
 6 files changed, 66 insertions(+), 5 deletions(-)

diff --git a/src/hooks/useHerbs.ts b/src/hooks/useHerbs.ts
index 3aa49a1..858bedb 100644
--- a/src/hooks/useHerbs.ts
+++ b/src/hooks/useHerbs.ts
@@ -2,10 +2,17 @@ import React from 'react'
 import type { Herb } from '../types'
 
 async function fetchHerbs(url: string): Promise<Herb[]> {
-  const res = await fetch(url)
-  if (!res.ok) throw new Error(`Failed to fetch ${url}`)
-  const text = await res.text()
-  return JSON.parse(text.replace(/NaN/g, 'null')) as Herb[]
+  try {
+    const res = await fetch(url)
+    if (!res.ok) {
+      throw new Error(`Failed to fetch ${url}: ${res.status}`)
+    }
+    const text = await res.text()
+    return JSON.parse(text.replace(/NaN/g, 'null')) as Herb[]
+  } catch (err) {
+    console.error('Error fetching herb data from', url, err)
+    throw err
+  }
 }
 
 export function useHerbs(): Herb[] | undefined {
diff --git a/src/pages/Compare.tsx b/src/pages/Compare.tsx
index d7353ea..85dc54b 100644
--- a/src/pages/Compare.tsx
+++ b/src/pages/Compare.tsx
@@ -18,6 +18,17 @@ export default function Compare() {
 
   const herbs = useHerbs()
 
+  if (herbs === undefined) {
+    return (
+      <div className='min-h-screen px-4 pt-20 text-center text-sand'>
+        <Helmet>
+          <title>Compare - The Hippie Scientist</title>
+        </Helmet>
+        <p>Loading herb data…</p>
+      </div>
+    )
+  }
+
   const herbList = React.useMemo(
     () => (herbs ? herbIds.map(id => herbs.find(h => h.id === id)).filter(Boolean) : []),
     [herbIds, herbs]
diff --git a/src/pages/Compounds.tsx b/src/pages/Compounds.tsx
index 70fd471..d6669a1 100644
--- a/src/pages/Compounds.tsx
+++ b/src/pages/Compounds.tsx
@@ -27,6 +27,17 @@ export default function Compounds() {
   const herbs = useHerbs()
   const [tagFilter, setTagFilter] = React.useState<string[]>([])
 
+  if (herbs === undefined) {
+    return (
+      <div className='min-h-screen px-4 pt-20 text-center text-sand'>
+        <Helmet>
+          <title>Psychoactive Compounds - The Hippie Scientist</title>
+        </Helmet>
+        <p>Loading herb data…</p>
+      </div>
+    )
+  }
+
   const compounds = React.useMemo(() => {
     const map = new Map<string, Compound>()
     baseCompounds.forEach(c => {
diff --git a/src/pages/Database.tsx b/src/pages/Database.tsx
index 787e029..ba7df3a 100644
--- a/src/pages/Database.tsx
+++ b/src/pages/Database.tsx
@@ -40,7 +40,21 @@ export default function Database() {
   const [compactMode, setCompactMode] = useLocalStorage<boolean>('dbCompact', false)
   const [params, setParams] = useSearchParams()
 
-  if (!herbs || herbs.length === 0) {
+  if (herbs === undefined) {
+    return (
+      <>
+        <Helmet>
+          <title>Database - The Hippie Scientist</title>
+        </Helmet>
+        <div className='relative min-h-screen px-4 pt-20'>
+          <StarfieldBackground />
+          <div className='text-center text-sand'>Loading herb data…</div>
+        </div>
+      </>
+    )
+  }
+
+  if (herbs.length === 0) {
     return (
       <>
         <Helmet>
diff --git a/src/pages/Favorites.tsx b/src/pages/Favorites.tsx
index d1a33f5..94e7f29 100644
--- a/src/pages/Favorites.tsx
+++ b/src/pages/Favorites.tsx
@@ -12,6 +12,17 @@ export default function Favorites() {
     [herbs, favorites]
   )
 
+  if (herbs === undefined) {
+    return (
+      <div className='min-h-screen px-4 pt-20 pb-12 text-center text-sand'>
+        <Helmet>
+          <title>My Herbs - The Hippie Scientist</title>
+        </Helmet>
+        <p>Loading herb data…</p>
+      </div>
+    )
+  }
+
   return (
     <div className='min-h-screen px-4 pt-20 pb-12'>
       <Helmet>
diff --git a/src/pages/HerbDetail.tsx b/src/pages/HerbDetail.tsx
index d22c872..1df599a 100644
--- a/src/pages/HerbDetail.tsx
+++ b/src/pages/HerbDetail.tsx
@@ -46,6 +46,13 @@ export default function HerbDetail() {
     setCopied(true)
     setTimeout(() => setCopied(false), 1500)
   }
+  if (herbs === undefined) {
+    return (
+      <div className='p-6 text-center'>
+        <p>Loading herb data…</p>
+      </div>
+    )
+  }
   if (!herb) {
     return (
       <div className='p-6 text-center'>
-- 
2.43.0

